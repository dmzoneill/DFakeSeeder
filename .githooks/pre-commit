#!/usr/bin/env bash
# Pre-commit hook: runs lint checks on staged Python files before allowing commit.
# Prevents broken code from being pushed.
#
# Install with:  git config core.hooksPath .githooks
# Or:            make setup-hooks

set -e

# Get list of staged .py files (excluding deleted files)
STAGED_PY=$(git diff --cached --name-only --diff-filter=d -- '*.py')

if [ -z "$STAGED_PY" ]; then
    # No Python files staged — skip lint checks
    exit 0
fi

echo "Pre-commit: checking staged Python files..."

# Determine the Python runner (pipenv if available, else direct)
if command -v pipenv &>/dev/null && [ -f Pipfile ]; then
    RUN="pipenv run"
else
    RUN=""
fi

# 1. Black — formatting check (no auto-fix, just fail if wrong)
echo "  [1/4] black --check"
$RUN black --check --quiet $STAGED_PY || {
    echo ""
    echo "FAILED: black found formatting issues."
    echo "Run 'make lint' to auto-fix, then re-stage the files."
    exit 1
}

# 2. isort — import ordering check
echo "  [2/4] isort --check"
$RUN isort --check-only --quiet $STAGED_PY || {
    echo ""
    echo "FAILED: isort found import ordering issues."
    echo "Run 'make lint' to auto-fix, then re-stage the files."
    exit 1
}

# 3. flake8 — linting errors
echo "  [3/4] flake8"
$RUN flake8 $STAGED_PY || {
    echo ""
    echo "FAILED: flake8 found linting errors."
    exit 1
}

# 4. mypy — type checking
echo "  [4/4] mypy"
$RUN mypy $STAGED_PY || {
    echo ""
    echo "FAILED: mypy found type errors."
    exit 1
}

echo "Pre-commit: all checks passed."

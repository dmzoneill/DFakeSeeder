name: RPM End-to-End Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # Allow manual triggering

jobs:
  rpm-e2e-tests:
    name: RPM E2E Tests on Fedora
    runs-on: ubuntu-latest

    strategy:
      matrix:
        fedora_version: ['latest', '39', '38']

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            rpm \
            rpmlint \
            xmllint \
            gettext \
            python3-gi \
            gir1.2-gtk-4.0

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install black flake8 isort

      - name: Build UI
        run: make ui-build

      - name: Run linting
        run: make lint
        continue-on-error: true  # Don't fail on lint warnings

      - name: Build RPM
        run: make rpm

      - name: List RPM contents
        run: |
          RPM_FILE=$(find ./rpmbuild/RPMS -name "dfakeseeder-*.rpm" | head -1)
          echo "RPM File: $RPM_FILE"
          rpm -qilp "$RPM_FILE"

      - name: Validate RPM with rpmlint
        run: |
          RPM_FILE=$(find ./rpmbuild/RPMS -name "dfakeseeder-*.rpm" | head -1)
          rpmlint "$RPM_FILE" || true  # Don't fail on warnings
        continue-on-error: true

      - name: Make test scripts executable
        run: |
          chmod +x tests/e2e/*.sh

      - name: Build E2E test container (Fedora ${{ matrix.fedora_version }})
        run: |
          cd tests/e2e
          docker build \
            --build-arg FEDORA_VERSION=${{ matrix.fedora_version }} \
            -t dfakeseeder-e2e-test:${{ matrix.fedora_version }} \
            -f Dockerfile.fedora .

      - name: Run installation tests
        run: |
          docker run --rm \
            -v $(pwd)/rpmbuild/RPMS:/rpms:ro \
            -v $(pwd)/tests/e2e:/workspace/tests:ro \
            -v $(pwd)/test-artifacts:/test-artifacts:rw \
            dfakeseeder-e2e-test:${{ matrix.fedora_version }} \
            /bin/bash /workspace/tests/test_rpm_installation.sh

      - name: Run launch tests
        run: |
          docker run --rm \
            --privileged \
            -v $(pwd)/rpmbuild/RPMS:/rpms:ro \
            -v $(pwd)/tests/e2e:/workspace/tests:ro \
            -v $(pwd)/test-artifacts:/test-artifacts:rw \
            -e DISPLAY=:99 \
            dfakeseeder-e2e-test:${{ matrix.fedora_version }} \
            /bin/bash -c "
              RPM_FILE=\$(find /rpms -name 'dfakeseeder-*.rpm' | head -1)
              sudo rpm -ivh \"\$RPM_FILE\"
              /bin/bash /workspace/tests/test_rpm_launch.sh
            "

      - name: Upload test artifacts
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: e2e-test-artifacts-fedora-${{ matrix.fedora_version }}
          path: |
            test-artifacts/
            rpmbuild/RPMS/
          retention-days: 7

      - name: Upload RPM package
        uses: actions/upload-artifact@v3
        if: success()
        with:
          name: dfakeseeder-rpm-fedora-${{ matrix.fedora_version }}
          path: rpmbuild/RPMS/noarch/*.rpm
          retention-days: 30

  pypi-compatibility-test:
    name: Test PyPI Installation Compatibility
    runs-on: ubuntu-latest
    needs: rpm-e2e-tests

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            python3-gi \
            gir1.2-gtk-4.0 \
            gtk4 \
            libgirepository1.0-dev

      - name: Build PyPI package
        run: make pypi-build

      - name: Install from built wheel
        run: |
          pip install dist/*.whl

      - name: Test imports
        run: |
          python -c "import d_fake_seeder"
          python -c "from d_fake_seeder.domain.app_settings import AppSettings"

      - name: Test CLI entry points
        run: |
          dfs --help || echo "CLI may require full GTK environment"

      - name: Upload PyPI package
        uses: actions/upload-artifact@v3
        if: success()
        with:
          name: dfakeseeder-pypi-package
          path: dist/*
          retention-days: 30

  test-report:
    name: Generate Test Report
    runs-on: ubuntu-latest
    needs: [rpm-e2e-tests, pypi-compatibility-test]
    if: always()

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v3

      - name: Generate summary report
        run: |
          echo "# DFakeSeeder E2E Test Results" > test-summary.md
          echo "" >> test-summary.md
          echo "## Test Execution Summary" >> test-summary.md
          echo "" >> test-summary.md
          echo "- **Date**: $(date)" >> test-summary.md
          echo "- **Commit**: ${{ github.sha }}" >> test-summary.md
          echo "- **Branch**: ${{ github.ref_name }}" >> test-summary.md
          echo "" >> test-summary.md
          echo "## Artifacts" >> test-summary.md
          ls -R

      - name: Upload summary
        uses: actions/upload-artifact@v3
        with:
          name: test-summary
          path: test-summary.md
          retention-days: 30
